<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acenda uma Vela Virtual</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f8f4f0; color: #333; line-height: 1.5; min-height: 100vh; }
        .container { max-width: 100%; margin: 0 auto; padding: 12px; min-height: 100vh; display: flex; flex-direction: column; }
        header { text-align: center; margin-bottom: 25px; padding: 15px 0; border-bottom: 1px solid #e0d6cc; }
        h1 { color: #663F18; font-size: 1.8rem; margin-bottom: 6px; }
        section { background-color: white; border-radius: 8px; padding: 18px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 18px; flex-grow: 1; }
        h2 { color: #663F18; margin-bottom: 15px; font-size: 1.3rem; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #663F18; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .error { color: #d9534f; font-size: 0.8rem; margin-top: 3px; }
        button { background-color: #C86514; color: white; border: none; padding: 16px 20px; font-size: 1rem; border-radius: 8px; cursor: pointer; display: block; margin: 20px auto; width: 100%; font-weight: 600; }
        .candle-container { text-align: center; padding: 25px 0; }
        .candle { position: relative; width: 50px; height: 100px; margin: 0 auto 20px; display: flex; flex-direction: column; align-items: center; }
        .candle-flame { width: 14px; height: 35px; background: radial-gradient(ellipse at center, #fffde7 0%, #ffeb3b 40%, #ff9800 80%, transparent 100%); border-radius: 50%; animation: flameFlicker 2s ease-in-out infinite; }
        @keyframes flameFlicker { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.9; } }
        .candle-wax { width: 45px; height: 85px; background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 40%, #e0e0e0 100%); border-radius: 10px; }
        .question-container { margin-bottom: 18px; }
        .question-text { font-size: 1.1rem; margin-bottom: 15px; color: #663F18; text-align: center; }
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option { background: #f8f4f0; border: 2px solid #e0d6cc; border-radius: 8px; padding: 14px; cursor: pointer; color: #663F18; font-size: 0.9rem; min-height: 60px; display: flex; align-items: center; }
        .option.selected { background: #f0e6dc; border-color: #C86514; }
        .progress-bar { width: 100%; height: 5px; background: #e0d6cc; border-radius: 6px; margin: 18px 0; overflow: hidden; }
        .progress { height: 100%; background: linear-gradient(90deg, #C86514, #663F18); border-radius: 6px; transition: width 0.5s ease; }
        .pix-container { text-align: center; padding: 18px; background: #f8f4f0; border-radius: 8px; margin: 15px 0; border: 2px solid #e0d6cc; }
        .pix-code { background: white; padding: 14px; border-radius: 6px; margin: 14px 0; border: 2px dashed #C86514; font-family: monospace; font-size: 0.85rem; color: #663F18; cursor: pointer; word-break: break-all; }
        .payment-processing { text-align: center; padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #C86514; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .confirmation-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(102, 63, 24, 0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 12px; }
        .confirmation-popup-content { background: white; padding: 22px; border-radius: 12px; text-align: center; width: 100%; max-width: 380px; }
        .confirmation-popup-buttons { display: flex; flex-direction: column; gap: 8px; }
        .payment-status { text-align: center; padding: 10px; margin: 10px 0; border-radius: 6px; }
        .payment-approved { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .payment-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // CONFIGURA√á√ïES DO BACK4APP
        const BACK4APP_APP_ID = "yh17p501Hj4lfKuPai9BizmilyWOXS13jVx7pXut";
        const BACK4APP_API_KEY = "todP7aQbhD8jKhMau2E71NuyQd3FVUclLbw0BKa3";
        const BACK4APP_URL = "https://parseapi.back4app.com/functions";

        function App() {
            const [currentPage, setCurrentPage] = useState('quiz');
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [answers, setAnswers] = useState([]);
            const [formData, setFormData] = useState({ name: '', city: '', state: '', reason: '', days: '7' });
            const [errors, setErrors] = useState({});
            const [paymentStatus, setPaymentStatus] = useState('pending');
            const [showConfirmationPopup, setShowConfirmationPopup] = useState(false);
            const [pixCode, setPixCode] = useState('');
            const [qrCode, setQrCode] = useState('');
            const [paymentId, setPaymentId] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [useFallback, setUseFallback] = useState(false);

            // PERGUNTAS COMPLETAS
            const questions = [
                { question: "Voc√™ sente que essa alma ainda precisa de luz para encontrar paz?", options: ["Sim, sinto uma energia pesada", "√Äs vezes sinto incompleto", "Tenho sonhos perturbadores", "Sinto que preciso ajudar", "N√£o tenho certeza"] },
                { question: "Quantas vezes pensou em fazer algo especial?", options: ["Muitas vezes", "Todo dia", "Recentemente", "Sempre", "Agora √© a hora"] },
                { question: "Acredita que um gesto de luz pode guiar essa alma?", options: ["Sim, busco a maneira", "Toda alma merece luz", "Para minha paz", "Minha miss√£o", "Todas as religi√µes falam"] },
                { question: "J√° recebeu sinais?", options: ["Sim, em sonhos", "Sinto energia pesada", "Coisas estranhas", "Sensa√ß√£o incompleta", "Toda alma merece"] },
                { question: "Quanto tempo carrega esse peso?", options: ["Dias de ang√∫stia", "Semanas sem dormir", "Meses de pensamentos", "Anos de culpa", "Agora ou nunca"] },
                { question: "O que impede voc√™?", options: ["N√£o sabia como", "N√£o encontrava momento", "Medo de n√£o ser suficiente", "Vida atrapalha", "Esperando sinal"] },
                { question: "Acredita que almas ficam presas?", options: ["Sim, n√£o quero isso", "Amor √© a ponte", "Nossa situa√ß√£o", "Tradi√ß√µes confirmam", "Prefiro garantir"] },
                { question: "Quantas vezes adiou?", options: ["Incont√°veis vezes", "V√°rias vezes", "Sinais fortes", "Sempre adiei", "√öltima chance"] },
                { question: "Sabia sobre velas consagradas?", options: ["N√£o, faz sentido", "J√° ouvi falar", "Sempre busquei", "Sinal esperado", "Preciso conex√£o"] },
                { question: "O que acontecer√≠a?", options: ["Paz eterna", "Conex√£o pura", "Me libertaria", "Descanso merecido", "Ciclo rompido"] },
                { question: "Usaria uma vela especial?", options: ["Sim, √© a resposta", "Imediatamente", "Solu√ß√£o real", "J√° devia ter feito", "Oportunidade √∫nica"] },
                { question: "Quantas almas j√° encontraram paz?", options: ["Milhares", "Incont√°veis", "Muitas", "Todas merecedoras", "Mais importante"] },
                { question: "Est√° preparado?", options: ["Chega de adiar", "Mais pronto que nunca", "Miss√£o espiritual", "N√£o posso mais", "Momento √© agora"] },
                { question: "O que seria pior?", options: ["Nunca tentar", "Saber que poderia", "Peso na consci√™ncia", "Deixar alma sem paz", "Todas alternativas"] },
                { question: "Est√° pronto para acender?", options: ["SIM!", "Caminho certo", "Resposta que busco", "Hora da diferen√ßa", "Miss√£o sagrada"] },
                { question: "Se n√£o for voc√™, quem? Se n√£o for agora, quando?", options: [
                    "EU SOU A PESSOA CERTA - AGORA √â O MOMENTO!",
                    "VOU DEIXAR ESSA ALMA NO ESCURO MAIS UMA VEZ"
                ]}
            ];

            // Chamar backend para criar pagamento COM FALLBACK
            const createPayment = async () => {
                setIsProcessing(true);
                try {
                    const response = await fetch(`${BACK4APP_URL}/createPayment`, {
                        method: 'POST',
                        headers: {
                            'X-Parse-Application-Id': BACK4APP_APP_ID,
                            'X-Parse-REST-API-Key': BACK4APP_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: formData.name,
                            amount: 6.99
                        })
                    });

                    const data = await response.json();
                    
                    if (data.result && data.result.success) {
                        setPixCode(data.result.pixCode);
                        setQrCode(data.result.qrCode);
                        setPaymentId(data.result.paymentId);
                        setPaymentStatus('pending');
                        setUseFallback(false);
                    } else {
                        throw new Error('Backend n√£o respondeu corretamente');
                    }

                } catch (error) {
                    console.log('Usando fallback - Backend offline');
                    // FALLBACK - PIX est√°tico
                    setPixCode("00020126580014br.gov.bcb.pix0136a1b2c3d4-e5f6-7890-1234-5678901234560215Vela Virtual52040000530398654046.995802BR5913VELA VIRTUAL6008Sao Paulo62070503***6304A1B2");
                    setPaymentId("FALLBACK_" + Date.now());
                    setPaymentStatus('pending');
                    setUseFallback(true);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Verificar status do pagamento
            const checkPaymentStatus = async () => {
                if (!paymentId) return;
                
                // Se est√° usando fallback, simular pagamento
                if (useFallback) {
                    // Simular pagamento aprovado ap√≥s 30 segundos
                    setTimeout(() => {
                        setPaymentStatus('approved');
                        setCurrentPage('candle');
                    }, 30000);
                    return;
                }

                try {
                    const response = await fetch(`${BACK4APP_URL}/checkPayment`, {
                        method: 'POST',
                        headers: {
                            'X-Parse-Application-Id': BACK4APP_APP_ID,
                            'X-Parse-REST-API-Key': BACK4APP_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            paymentId: paymentId
                        })
                    });

                    const data = await response.json();
                    
                    if (data.result && data.result.success && data.result.approved) {
                        setPaymentStatus('approved');
                        setCurrentPage('candle');
                    }
                } catch (error) {
                    console.error('Erro ao verificar:', error);
                }
            };

            // Verificar pagamento a cada 10 segundos
            useEffect(() => {
                let interval;
                if (paymentId && paymentStatus === 'pending') {
                    interval = setInterval(checkPaymentStatus, 10000);
                }
                return () => clearInterval(interval);
            }, [paymentId, paymentStatus]);

            const handleAnswer = (index) => {
                const newAnswers = [...answers];
                newAnswers[currentQuestion] = index;
                setAnswers(newAnswers);
                if (currentQuestion < questions.length - 1) {
                    setTimeout(() => setCurrentQuestion(currentQuestion + 1), 400);
                } else {
                    setTimeout(() => setCurrentPage('form'), 800);
                }
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                const newErrors = {};
                if (!formData.name.trim()) newErrors.name = 'Nome obrigat√≥rio';
                if (!formData.city.trim()) newErrors.city = 'Cidade obrigat√≥ria';
                if (!formData.state.trim()) newErrors.state = 'Estado obrigat√≥rio';
                if (!formData.reason.trim()) newErrors.reason = 'Motivo obrigat√≥rio';
                setErrors(newErrors);
                if (Object.keys(newErrors).length === 0) setShowConfirmationPopup(true);
            };

            const handleConfirmPayment = () => {
                createPayment();
                setShowConfirmationPopup(false);
                setCurrentPage('payment');
            };

            const copyPixCode = () => {
                navigator.clipboard.writeText(pixCode).then(() => {
                    alert('C√≥digo PIX copiado!');
                });
            };

            const progress = ((currentQuestion + 1) / questions.length) * 100;

            return (
                <div className="container">
                    <header>
                        <h1>Acenda uma Vela Virtual</h1>
                        <p className="subtitle">Um gesto simb√≥lico de luz, esperan√ßa e lembran√ßa</p>
                    </header>

                    {currentPage === 'quiz' && (
                        <section>
                            <div className="progress-bar"><div className="progress" style={{width: `${progress}%`}}></div></div>
                            <div className="question-container">
                                <h2 className="question-text">{questions[currentQuestion].question}</h2>
                                <div className="options-container">
                                    {questions[currentQuestion].options.map((option, index) => (
                                        <div key={index} className={`option ${answers[currentQuestion] === index ? 'selected' : ''}`} onClick={() => handleAnswer(index)}>
                                            {option}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>
                    )}

                    {currentPage === 'form' && (
                        <section>
                            <h2>Complete sua Jornada</h2>
                            <form onSubmit={handleFormSubmit}>
                                <div className="form-group"><label>Nome *</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="Digite o nome" />{errors.name && <div className="error">{errors.name}</div>}</div>
                                <div className="form-group"><label>Cidade *</label><input type="text" value={formData.city} onChange={(e) => setFormData({...formData, city: e.target.value})} placeholder="Digite a cidade" />{errors.city && <div className="error">{errors.city}</div>}</div>
                                <div className="form-group"><label>Estado *</label><input type="text" value={formData.state} onChange={(e) => setFormData({...formData, state: e.target.value})} placeholder="Digite o estado" />{errors.state && <div className="error">{errors.state}</div>}</div>
                                <div className="form-group"><label>Motivo *</label><textarea value={formData.reason} onChange={(e) => setFormData({...formData, reason: e.target.value})} placeholder="Descreva o motivo" />{errors.reason && <div className="error">{errors.reason}</div>}</div>
                                <div className="form-group"><label>Dura√ß√£o</label><select value={formData.days} onChange={(e) => setFormData({...formData, days: e.target.value})}><option value="1">1 dia</option><option value="7">7 dias</option></select></div>
                                <button type="submit">Acender Vela</button>
                            </form>
                        </section>
                    )}

                    {currentPage === 'payment' && (
                        <section>
                            <h2>Pagamento PIX</h2>
                            <div className="pix-container">
                                {isProcessing ? (
                                    <div className="payment-processing"><div className="loader"></div><p>Gerando PIX...</p></div>
                                ) : (
                                    <>
                                        <p><strong>Valor: R$ 6,99</strong></p>
                                        {useFallback && <div className="payment-status payment-pending">‚ö†Ô∏è Modo offline - Use o c√≥digo PIX abaixo</div>}
                                        {qrCode && !useFallback && <img src={`data:image/png;base64,${qrCode}`} alt="QR Code PIX" style={{maxWidth: '200px', margin: '15px auto', display: 'block', border: '2px solid #C86514', borderRadius: '8px'}} />}
                                        {pixCode && <div className="pix-code" onClick={copyPixCode}>{pixCode}<br/><small>(Clique para copiar)</small></div>}
                                        <p>üì± Use o c√≥digo PIX acima<br/>‚úÖ {useFallback ? 'Pagamento simulado' : 'Pagamento verificado automaticamente'}</p>
                                        {paymentStatus === 'pending' && <div className="payment-status payment-pending">‚è≥ Aguardando confirma√ß√£o...</div>}
                                        {paymentStatus === 'approved' && <div className="payment-status payment-approved">‚úÖ Pagamento confirmado!</div>}
                                    </>
                                )}
                            </div>
                        </section>
                    )}

                    {currentPage === 'candle' && paymentStatus === 'approved' && (
                        <section>
                            <div className="candle-container">
                                <h2>Vela Acesa com Sucesso! üôè</h2>
                                <div className="candle"><div className="candle-flame"></div><div className="candle-wax"></div></div>
                                <div className="candle-info">
                                    <h3>Vela acesa para: {formData.name}</h3>
                                    <p><strong>Cidade:</strong> {formData.city}</p>
                                    <p><strong>Estado:</strong> {formData.state}</p>
                                    <p><strong>Motivo:</strong> {formData.reason}</p>
                                    <p><strong>Dura√ß√£o:</strong> {formData.days} dias</p>
                                </div>
                                <button onClick={() => { setCurrentPage('quiz'); setCurrentQuestion(0); setAnswers([]); setPaymentStatus('pending'); setUseFallback(false); }}>Acender Outra Vela</button>
                            </div>
                        </section>
                    )}

                    {showConfirmationPopup && (
                        <div className="confirmation-popup">
                            <div className="confirmation-popup-content">
                                <h3>‚ú® Confirmar Vela ‚ú®</h3>
                                <p>Para: <strong>{formData.name}</strong></p>
                                <p>Valor: <strong>R$ 6,99</strong></p>
                                <div className="confirmation-popup-buttons">
                                    <button onClick={handleConfirmPayment}>‚úÖ CONFIRMAR E PAGAR</button>
                                    <button onClick={() => setShowConfirmationPopup(false)}>‚ùå CANCELAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
